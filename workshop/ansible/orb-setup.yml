---
- hosts: localhost
  gather_facts: false

  pre_tasks:
    - name: Set the required variables
      set_fact:
        ingest_token: "{{ lookup('env','ACCESS_TOKEN') }}"
        rum_token: "{{ lookup('env','RUM_TOKEN') }}"
        realm: "{{ lookup('env','REALM') }}"
        instance: "{{ lookup('env','INSTANCE') }}"
        hec_url: "{{ lookup('env','HEC_URL') }}"
        hec_token: "{{ lookup('env','HEC_TOKEN') }}"

  tasks:
      - name: Add environment variables to .profile
        ansible.builtin.blockinfile:
          path: /etc/skel/.profile
          prepend_newline: true
          block: |
            export REALM={{ realm }}
            export ACCESS_TOKEN={{ ingest_token }}
            export RUM_TOKEN={{ rum_token }}
            export HEC_TOKEN={{ hec_token }}
            export HEC_URL={{ hec_url }}
        become: true
        when: not wh_result.stat.exists

      - name: Create workshop secrets deployment YAML
        file:
          path: /home/splunk/splunk-k8s-secrets.yaml
          owner: splunk
          group: splunk
          state: touch
        become: true
        when: not wh_result.stat.exists

      - name: Update yaml for workshop secrets
        ansible.builtin.blockinfile:
          path: /home/splunk/splunk-k8s-secrets.yaml
          block: |
            apiVersion: v1
            kind: Secret
            metadata:
              name: splunk-secrets
              namespace: default
            type: Opaque
            stringData:
              app: {{ instance }}
              deployment: "deployment.environment={{ instance }}"
              instance: {{ instance }}
              realm: {{ realm }}
              rum_token: {{ rum_token }}
          marker: "## {mark} Added by ansible (configuration Demo-in-a-Box)"
        become: true
        when: not wh_result.stat.exists

      - name: Demo-in-a-Box Kubernetes setup
        command: kubectl apply -f splunk-k8s-secrets.yaml
        when: not wh_result.stat.exists
